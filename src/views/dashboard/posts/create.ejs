<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Create New Post</h5>
            </div>
            <div class="card-body">
                <form method="POST" action="/dashboard/posts/create">
                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <label for="title" class="form-label">Title *</label>
                            <input type="text" class="form-control" id="title" name="title" placeholder="Enter post title...">
                        </div>

                        <div class="col-md-4 mb-3">
                            <label for="status" class="form-label">Status</label>
                            <select class="form-select" id="status" name="status">
                                <option value="draft">Draft</option>
                                <option value="published" selected>Published</option>
                            </select>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="category" class="form-label">Category *</label>
                            <select class="form-select" id="category" name="category" required onchange="toggleReelsMode()">
                                <option value="">Select Category</option>
                                <% if (categories && categories.length > 0) { %>
                                    <% categories.forEach(category => { %>
                                        <option value="<%= category._id %>" data-slug="<%= category.slug %>"><%= category.name %></option>
                                    <% }); %>
                                <% } %>
                            </select>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="author" class="form-label">Author</label>
                            <select class="form-select" id="author" name="author">
                                <% if (users && users.length > 0) { %>
                                    <% users.forEach(u => { %>
                                        <option value="<%= u._id %>">
                                            <%= u.name %>
                                        </option>
                                    <% }); %>
                                <% } %>
                            </select>
                        </div>
                    </div>

                    <!-- Regular Post Fields -->
                    <div id="regularPostFields">
                    <div class="mb-3">
                        <label for="excerpt" class="form-label">Excerpt</label>
                        <textarea class="form-control" id="excerpt" name="excerpt" rows="3" placeholder="Brief summary of the post"></textarea>
                    </div>

                    <!-- Image Upload Section -->
                    <div class="mb-3">
                        <label class="form-label">Featured Image</label>
                        <div class="border rounded p-3">
                            <div class="mb-3">
                                    <input type="file" class="form-control" id="imageFile" accept="image/*" onchange="previewImage(this)">
                            </div>
                            <div id="imagePreview" class="d-none">
                                <img id="previewImg" src="" alt="Preview" class="img-thumbnail" style="max-width: 200px; max-height: 200px;">
                                <button type="button" class="btn btn-sm btn-danger mt-2" onclick="removeImage()">Remove Image</button>
                            </div>
                        </div>
                    </div>

                    <!-- HTML Editor -->
                    <div class="mb-3">
                        <label for="content" class="form-label">Content *</label>
                        <div class="editor-toolbar mb-2">
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="formatText('bold')" title="Bold">
                                <i class="fas fa-bold"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="formatText('italic')" title="Italic">
                                <i class="fas fa-italic"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="formatText('underline')" title="Underline">
                                <i class="fas fa-underline"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="formatText('insertUnorderedList')" title="Bullet List">
                                <i class="fas fa-list-ul"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="formatText('insertOrderedList')" title="Numbered List">
                                <i class="fas fa-list-ol"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="insertLink()" title="Insert Link">
                                <i class="fas fa-link"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="insertImage()" title="Insert Image">
                                <i class="fas fa-image"></i>
                            </button>
                        </div>
                            <div id="editor" contenteditable="true" class="form-control" style="min-height: 300px; border: 1px solid #ced4da; border-radius: 0.375rem; padding: 0.375rem 0.75rem;" placeholder="Start writing your post content here..."></div>
                            <input type="hidden" name="imageUrl" id="image">
                        <textarea name="content" id="content" class="d-none"></textarea>
                        </div>
                    </div>

                    <!-- Reels Post Fields -->
                    <div id="reelsPostFields" style="display: none;">
                        <div class="alert alert-info">
                            <i class="fas fa-video me-2"></i>
                            <strong>Reels Post:</strong> Video URL, thumbnail image, and basic information are required for reels.
                        </div>

                        <div class="row">
                            <div class="col-md-8 mb-3">
                                <label for="videoUrl" class="form-label">Video URL *</label>
                                <input type="url" class="form-control" id="videoUrl" name="videoUrl" placeholder="https://youtube.com/watch?v=... or https://youtu.be/...">
                                <div class="form-text">Enter the full YouTube URL for the video</div>
                            </div>

                            <div class="col-md-4 mb-3">
                                <label for="videoTitle" class="form-label">Video Title Override (Optional)</label>
                                <input type="text" class="form-control" id="videoTitle" name="videoTitleOverride" placeholder="Leave empty to use video title from URL">
                                <div class="form-text">If not provided, the title will be extracted from the video metadata</div>
                            </div>
                        </div>

                        <!-- Thumbnail Image Upload for Reels -->
                        <div class="mb-3">
                            <label class="form-label">Thumbnail Image *</label>
                            <div class="border rounded p-3">
                                <div class="mb-3">
                                    <input type="file" class="form-control" id="reelsImageFile" accept="image/*">
                                    <input type="hidden" id="reelsImage" name="reelsImageUrl">
                                </div>
                                <div id="reelsImagePreview" class="d-none">
                                    <img id="reelsPreviewImg" src="" alt="Preview" class="img-thumbnail" style="max-width: 200px; max-height: 200px;">
                                    <button type="button" class="btn btn-sm btn-danger mt-2" onclick="removeReelsImage()">Remove Image</button>
                                </div>
                                <div class="form-text">Upload a custom thumbnail image for the reel (optional, will use video thumbnail if not provided)</div>
                            </div>
                        </div>
                    </div>

                    <!-- SEO Fields -->
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="metaTitle" class="form-label">Meta Title</label>
                            <input type="text" class="form-control" id="metaTitle" name="metaTitle">
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="metaDescription" class="form-label">Meta Description</label>
                            <input type="text" class="form-control" id="metaDescription" name="metaDescription">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="tags" class="form-label">Tags</label>
                        <input type="text" class="form-control" id="tags" name="tags" placeholder="tag1, tag2, tag3">
                        <div class="form-text">Separate tags with commas</div>
                    </div>

                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="isFeatured" name="isFeatured" value="true">
                            <label class="form-check-label" for="isFeatured">
                                Featured Post
                            </label>
                            <div class="form-text">Mark this post as featured to highlight it on the homepage</div>
                        </div>
                    </div>

                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>Create Post
                        </button>
                        <a href="/dashboard/posts" class="btn btn-secondary">
                            <i class="fas fa-arrow-left me-2"></i>Cancel
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>

// Function to toggle between regular post and reels mode
function toggleReelsMode() {
    const categorySelect = document.getElementById('category');
    const selectedOption = categorySelect.options[categorySelect.selectedIndex];
    const categorySlug = selectedOption.getAttribute('data-slug');

    const regularFields = document.getElementById('regularPostFields');
    const reelsFields = document.getElementById('reelsPostFields');
    const excerptField = document.getElementById('excerpt').closest('.mb-3');
    const tagsField = document.getElementById('tags').closest('.mb-3');
    const featuredField = document.getElementById('isFeatured').closest('.mb-3');

    // Get form elements
    const regularContentField = document.getElementById('content');
    const videoUrlField = document.getElementById('videoUrl');

    if (categorySlug === 'reels') {
        // Show reels fields, hide regular fields
        regularFields.style.display = 'none';
        reelsFields.style.display = 'block';

        // Hide excerpt, tags, and featured for reels
        if (excerptField) excerptField.style.display = 'none';
        if (tagsField) tagsField.style.display = 'none';
        if (featuredField) featuredField.style.display = 'none';

        // Disable regular content field to prevent it from being submitted
        if (regularContentField) regularContentField.disabled = true;
        // Enable video URL field
        if (videoUrlField) {
            videoUrlField.disabled = false;
            videoUrlField.setAttribute('required', 'required');
        }
    } else {
        // Show regular fields, hide reels fields
        regularFields.style.display = 'block';
        reelsFields.style.display = 'none';

        // Show excerpt, tags, and featured for regular posts
        if (excerptField) excerptField.style.display = 'block';
        if (tagsField) tagsField.style.display = 'block';
        if (featuredField) featuredField.style.display = 'block';

        // Enable regular content field
        if (regularContentField) regularContentField.disabled = false;
        // Disable and clear video URL field
        if (videoUrlField) {
            videoUrlField.disabled = true;
            videoUrlField.removeAttribute('required');
            videoUrlField.value = '';
        }
    }
}

// Function to handle reels image upload
async function uploadReelsImage(file) {
    if (!file) return;

    console.log('Starting reels image upload for file:', file.name, 'size:', file.size);

    const formData = new FormData();
    formData.append('image', file);

    try {
        isUploading = true;
        console.log('Sending upload request to /api/upload');

        const response = await fetch('/api/upload', {
            method: 'POST',
            body: formData,
            credentials: 'include' // Include cookies for authentication
        });

        console.log('Upload response status:', response.status);

        if (!response.ok) {
            const errorText = await response.text();
            console.error('Upload failed with status:', response.status, 'response:', errorText);
            throw new Error(`Upload failed: ${response.status} - ${errorText}`);
        }

        const result = await response.json();
        console.log('Upload response data:', result);

        if (result && result.result && result.result.secure_url) {
            document.getElementById('reelsImage').value = result.result.secure_url;
            document.getElementById('reelsPreviewImg').src = result.result.secure_url;
            document.getElementById('reelsImagePreview').classList.remove('d-none');
            console.log('Reels image uploaded successfully:', result.result.secure_url);
        } else {
            console.error('Invalid response format:', result);
            throw new Error('Upload response invalid - missing secure_url');
        }
    } catch (error) {
        console.error('Reels image upload error:', error);
        alert(`Failed to upload image: ${error.message}`);
    } finally {
        isUploading = false;
    }
}

// Function to remove reels image
function removeReelsImage() {
    document.getElementById('reelsImage').value = '';
    document.getElementById('reelsImagePreview').classList.add('d-none');
    document.getElementById('reelsImageFile').value = '';
}

// Add event listeners for file inputs
document.addEventListener('DOMContentLoaded', function() {
    // Regular image upload
    document.getElementById('imageFile').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            uploadImage(file);
        }
    });

    // Reels image upload
    document.getElementById('reelsImageFile').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            uploadReelsImage(file);
    }
    });

    // Initialize form state
    toggleReelsMode();
});

let isUploading = false;

async function uploadImage(file) {
    console.log('=== UPLOAD FUNCTION STARTED - THIS SHOULD APPEAR ===');
    console.log('File to upload:', file.name, 'Size:', file.size, 'Type:', file.type);
    isUploading = true;

    // Check if user has auth token
    const cookies = document.cookie;
    console.log('Current cookies:', cookies);
    const hasToken = cookies.includes('token=');
    console.log('Has token cookie:', hasToken);

    const formData = new FormData();
    formData.append('image', file);
    console.log('FormData created with file');

    try {
        console.log('Making fetch request to /api/upload...');
        const response = await fetch('/api/upload', {
            method: 'POST',
            body: formData,
            credentials: 'same-origin'
        });

        console.log('=== UPLOAD RESPONSE RECEIVED ===');
        console.log('Response status:', response.status);
        console.log('Response headers:', Object.fromEntries(response.headers.entries()));

        if (response.ok) {
            const result = await response.json();
            console.log('Upload response body:', result);
            console.log('Extracted URL:', result.result?.secure_url);

            if (result.result && result.result.secure_url) {
                document.getElementById('image').value = result.result.secure_url;
                console.log('=== UPLOAD SUCCESSFUL ===');
                console.log('Hidden field set to:', result.result.secure_url);
                alert('Image uploaded successfully!');
            } else {
                console.error('Invalid response format - no URL in result');
                alert('Upload response invalid. Please try again.');
            }
        } else {
            const errorText = await response.text();
            console.error('=== UPLOAD FAILED ===');
            console.error('Status:', response.status);
            console.error('Error response:', errorText);

            if (response.status === 401) {
                alert('Authentication failed. Please log in again.');
            } else {
            alert('Image upload failed. Please try again.');
            }
        }
    } catch (error) {
        console.error('=== UPLOAD ERROR ===');
        console.error('Network/fetch error:', error);
        alert('Network error during upload. Please try again.');
    } finally {
        isUploading = false;
        console.log('Upload function completed, isUploading set to false');
    }
}

function removeImage() {
    document.getElementById('imageFile').value = '';
    document.getElementById('image').value = 'REMOVE_IMAGE';
    document.getElementById('imagePreview').classList.add('d-none');
}

// HTML Editor functionality
function formatText(command) {
    const editor = document.getElementById('editor');
    const selection = window.getSelection();
    const range = selection.getRangeAt(0);

    if (!range) return;

    switch(command) {
        case 'bold':
            wrapSelection('<strong>', '</strong>');
            break;
        case 'italic':
            wrapSelection('<em>', '</em>');
            break;
        case 'underline':
            wrapSelection('<u>', '</u>');
            break;
        case 'insertUnorderedList':
            insertList('ul');
            break;
        case 'insertOrderedList':
            insertList('ol');
            break;
    }

    updateHiddenTextarea();
    editor.focus();
}

function wrapSelection(openTag, closeTag) {
    const selection = window.getSelection();
    if (selection.rangeCount === 0) return;

    const range = selection.getRangeAt(0);
    const selectedText = range.toString();

    if (selectedText) {
        const newNode = document.createElement('div');
        newNode.innerHTML = openTag + selectedText + closeTag;
        range.deleteContents();
        range.insertNode(newNode.firstChild);
    }
}

function insertList(type) {
    const selection = window.getSelection();
    if (selection.rangeCount === 0) return;

    const range = selection.getRangeAt(0);
    const list = document.createElement(type);
    const listItem = document.createElement('li');
    listItem.textContent = 'List item';
    list.appendChild(listItem);

    range.deleteContents();
    range.insertNode(list);
}

function insertLink() {
    const url = prompt('Enter URL:');
    if (url) {
        wrapSelection('<a href="' + url + '">', '</a>');
    }
    document.getElementById('editor').focus();
}

function insertImage() {
    const url = prompt('Enter image URL:');
    if (url) {
        const img = document.createElement('img');
        img.src = url;
        img.style.maxWidth = '100%';
        img.style.height = 'auto';

        const selection = window.getSelection();
        if (selection.rangeCount > 0) {
            const range = selection.getRangeAt(0);
            range.deleteContents();
            range.insertNode(img);
        }
    }
    document.getElementById('editor').focus();
}

function updateHiddenTextarea() {
    document.getElementById('content').value = document.getElementById('editor').innerHTML;
}

// Content editor with synchronization
// Global error handler
window.addEventListener('error', function(e) {
    console.error('Global JavaScript error:', e.error);
    console.error('Error message:', e.message);
    console.error('Error file:', e.filename);
    console.error('Error line:', e.lineno);
});

window.addEventListener('unhandledrejection', function(e) {
    console.error('Unhandled promise rejection:', e.reason);
});

document.addEventListener('DOMContentLoaded', function() {
        // Set up file input handling
        const fileInput = document.getElementById('imageFile');
        if (fileInput) {
            fileInput.addEventListener('change', function(e) {
                if (this.files && this.files.length > 0) {
                    const file = this.files[0];

                    // Validate file
                    if (file.size === 0 || !file.type.startsWith('image/')) {
                        alert('Please select a valid image file.');
                        return;
                    }

                    // Upload file
                    uploadImage(file);

                    // Show preview
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const img = document.getElementById('previewImg');
                        const preview = document.getElementById('imagePreview');
                        if (img && preview) {
                            img.src = e.target.result;
                            preview.classList.remove('d-none');
                        }
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

    const editor = document.getElementById('editor');
    const hiddenTextarea = document.getElementById('content');
    const form = document.querySelector('form');

    // Function to sync content - save HTML but clean it up
    function syncContent() {
        let html = editor.innerHTML;

        // Clean up unwanted HTML
        // Remove empty paragraphs and line breaks
        html = html.replace(/<p>\s*<\/p>/gi, '');
        html = html.replace(/<div>\s*<br\s*\/?>\s*<\/div>/gi, '');
        html = html.replace(/<br\s*\/?>/gi, '');
        html = html.replace(/\s+/g, ' ').trim();

        // If content is just placeholder or empty, save empty string
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = html;
        const textContent = tempDiv.textContent || tempDiv.innerText || '';

        if (textContent.trim() === '' || textContent.trim() === 'Start writing your post content here...') {
            hiddenTextarea.value = '';
        } else {
            // Save the cleaned HTML
        hiddenTextarea.value = html;
        }

        console.log('Content synced - Cleaned HTML:', html);
    }

    // Add placeholder functionality
    function updatePlaceholder() {
        if (editor.innerHTML.trim() === '' || editor.innerHTML.trim() === '<br>' || editor.innerHTML.trim() === '<div><br></div>') {
            editor.innerHTML = '';
            editor.setAttribute('data-placeholder', 'Start writing your post content here...');
            editor.classList.add('empty');
        } else {
            editor.removeAttribute('data-placeholder');
            editor.classList.remove('empty');
        }
    }

    // Initialize placeholder
    updatePlaceholder();

    // Sync on key events
    editor.addEventListener('input', function() {
        updatePlaceholder();
        syncContent();
    });
    editor.addEventListener('blur', syncContent);
    editor.addEventListener('paste', function() { setTimeout(syncContent, 100); });

    // Clear placeholder on focus
    editor.addEventListener('focus', function() {
        if (editor.classList.contains('empty')) {
            editor.innerHTML = '';
            editor.classList.remove('empty');
        }
    });

    // Force sync before form submission
    form.addEventListener('submit', function(e) {
        if (isUploading) {
            e.preventDefault();
            alert('Please wait for image upload to complete before submitting.');
            return;
        }

        syncContent();
    });

    // Initial sync after a short delay to ensure editor is ready
    setTimeout(function() {
        syncContent();
        console.log('Initial sync completed');
    }, 100);
});
</script>
